# komitto(コミット)

[English](./README.md) | [日本語](./README-ja.md)

`git diff`の情報から、セマンティックなコミットメッセージプロンプトを生成するためのCLIツールです。生成されたプロンプトは自動的にクリップボードにコピーされ、LLMに貼り付けることで、コミットメッセージを作成できます。

## 主な機能

- ステージングされた変更（`git diff --staged`）を解析
- 変更内容をLLMが理解しやすいXML形式に変換
- **LLM API連携**: OpenAI, Gemini, Anthropic, Ollama等のAPIを直接呼び出し、コミットメッセージを自動生成
- **文脈理解**: 直近のコミットログを自動でプロンプトに含めることで、プロジェクトの文脈やスタイルを考慮
- コミットメッセージ生成用のシステムプロンプトと結合
- 生成された最終的なプロンプトをクリップボードにコピー
- 変更に関する追加のコンテキスト（補足情報）をコマンドライン引数で付与する機能
- **インタラクティブモード**: 生成されたメッセージの確認、編集、再生成、またはコミットを対話形式で行います
- **エディタ連携**: お好みのエディタを使用してコミットメッセージを編集できます
- **堅牢なエラーハンドリング**: さまざまなエラーシナリオを適切に処理し、役立つフィードバックを提供します

## インストール

```bash
pip install komitto
```

もし開発用にインストールする場合は、以下のコマンドを使用してください。

```bash
pip install -e .
```

## 言語サポート

komittoは、OSのロケール設定に基づいて言語を自動的に検出します。
現在サポートされている言語は以下の通りです：
- 英語 (`en`) - デフォルト
- 日本語 (`ja`)

特定の言語を強制的に使用したい場合は、環境変数 `KOMITTO_LANG` を設定してください：

```bash
# Linux/macOS
export KOMITTO_LANG=ja

# Windows (PowerShell)
$env:KOMITTO_LANG="ja"
```

## 使い方

### 基本的な使い方 (プロンプト生成モード)

1.  リポジトリで変更を行い、`git add`でファイルをステージングします。
2.  `komitto`コマンドを実行します。
3.  生成されたプロンプトがクリップボードにコピーされるので、ChatGPT等に貼り付けます。

### AI自動生成モード (推奨)

設定ファイル (`komitto.toml`) にAPI設定を記述すると、`komitto` コマンド実行時にAPIを呼び出し、生成されたコミットメッセージを直接クリップボードにコピーします。

```bash
komitto
# -> 🤖 AIがコミットメッセージを生成中...
# -> ✅ 生成されたメッセージをクリップボードにコピーしました！
```

### インタラクティブモード

`-i` または `--interactive` オプションを付けて実行すると、生成されたメッセージを確認・編集してからコミットできます。

```bash
komitto -i
```

実行後、以下の操作を選択できます：
- **y: 採用(コミット)**: メッセージを採用し、自動的に `git commit` を実行します。
- **e: 編集**: エディタを起動してメッセージを修正します。
- **r: 再生成**: メッセージを再生成します。
- **n: キャンセル**: 何もせずに終了します。

**注意**: インタラクティブモードは、`komitto.toml` でLLM API設定が行われている場合のみ使用可能です。

### 追加コンテキストを渡す

変更の意図や特記事項など、プロンプトに含めたい補足情報がある場合は、引数として渡すことができます。

```bash
komitto "この変更は緊急のバグ修正です"
```

### エディタ連携

インタラクティブモードを使用する際、お好みのエディタを使ってメッセージを編集できます。エディタは以下の順序で決定されます：
- `GIT_EDITOR` 環境変数
- `VISUAL` 環境変数
- `EDITOR` 環境変数
- Git設定の `GIT_EDITOR`
- デフォルトエディタ（Windowsではnotepad、その他ではvi）

```bash
komitto -i
e
# -> エディタが開きます
```

## 設定ファイルによるカスタマイズ

以下のコマンドを実行することで、カレントディレクトリに設定ファイルの雛形（`komitto.toml`）を生成できます。

```bash
komitto init
```

プロンプトの内容は、TOML形式の設定ファイルを作成することでカスタマイズ可能です。
以下の順序で設定ファイルを探索し、見つかった設定がデフォルト設定を上書きします（後勝ち）。

1.  **OSごとのユーザー設定ディレクトリ**（グローバル設定）
    *   **Windows**: `%APPDATA%\komitto\config.toml`
    *   **macOS**: `~/Library/Application Support/komitto/config.toml`
    *   **Linux**: `~/.config/komitto/config.toml`
2.  **カレントディレクトリ**（プロジェクト固有設定）
    *   `./komitto.toml`

### 設定ファイル (`komitto.toml` / `config.toml`) の記述例

```toml
[prompt]
# システムプロンプトの上書き
system = """
あなたは関西弁の陽気なエンジニアです。
...
"""

[llm]
# AI自動生成を使用する場合は以下を設定してください
provider = "openai" # "openai", "gemini", "anthropic"

# モデル指定
model = "gpt-5.2"

# APIキー (省略時は環境変数を使用: OPENAI_API_KEY 等)
# api_key = "sk-..." 

# Ollama / LM Studio 等を使用する場合
# base_url = "http://localhost:11434/v1"

# プロンプトに含める過去のコミット履歴数 (デフォルト: 5)
history_limit = 5

[git]
# 差分解析から除外するファイル（globパターン）
# デフォルトの除外対象: package-lock.json, yarn.lock, pnpm-lock.yaml, poetry.lock, Cargo.lock, go.sum, *.lock
exclude = [
    "package-lock.json",
    "yarn.lock",
    "*.lock"
]
```

### Ollama/LM Studio の使用

OllamaやLM StudioをLLMプロバイダーとして使用するには、`base_url` パラメータを設定してください：

```toml
[llm]
provider = "openai"
model = "qwen3"
base_url = "http://localhost:11434/v1"
# オプション: ローカルインスタンスではAPIキーが不要な場合があります
# api_key = "dummy"
```

これにより、OpenAI互換のAPIインターフェースを使用しながら、ローカルでホストされているLLMモデルを利用できます。


## 仕組み

1.  `git diff --staged` を実行し、ステージングされたファイルの差分を取得します。
2.  差分情報を、ファイルパス、関数/クラス名、変更の種類（追加、修正、削除）などを含む構造化されたXML形式に変換します。
3.  あらかじめ定義されたシステムプロンプト、ユーザーが指定した追加コンテキスト、XML形式の差分情報を結合して、最終的なプロンプトを生成します。
4.  生成されたプロンプトをクリップボードにコピーします。
